name: 'Terraform Apply (Bulk)'

on:
  workflow_dispatch:
    inputs:
      number_of_instances:
        description: "Number of lab instances to launch (e.g. 5 for student-01 through student-05)"
        required: true
        type: number
      module:
        type: choice
        description: "Module to deploy for each instance"
        options:
          - module-1
          - module-2
        required: true
      region:
        description: "AWS region. Leave empty for eu-west-3 (Paris)."
        required: false
        type: string

permissions: write-all

jobs:
  generate-ids:
    name: 'Generate student IDs'
    runs-on: ubuntu-latest
    outputs:
      student_ids: ${{ steps.ids.outputs.student_ids }}
    steps:
      - name: Build student IDs array
        id: ids
        run: |
          n="${{ github.event.inputs.number_of_instances }}"
          [ -z "$n" ] || [ "$n" -lt 1 ] && n=1
          [ "$n" -gt 50 ] && n=50
          arr="["
          for i in $(seq 1 "$n"); do
            [ $i -gt 1 ] && arr+=","
            arr+="\"$(printf '%02d' $i)\""
          done
          arr+="]"
          echo "student_ids=$arr" >> $GITHUB_OUTPUT
          echo "Generated: $arr"

  terraform:
    name: 'Apply (${{ matrix.student_id }})'
    needs: generate-ids
    runs-on: ubuntu-latest
    environment: production
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        student_id: ${{ fromJson(needs.generate-ids.outputs.student_ids) }}
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: "eu-west-3"

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.10.5

      - name: Set Account ID and Region
        id: account
        run: |
          echo "ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_ENV
          echo "AWS_REGION=${{ github.event.inputs.region || env.AWS_REGION || 'eu-west-3' }}" >> $GITHUB_ENV
          aws configure set region ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: |
          cd modules/${{ github.event.inputs.module }}
          terraform init

      - name: Terraform Workspace
        run: |
          cd modules/${{ github.event.inputs.module }}
          terraform workspace select ${{ matrix.student_id }} 2>/dev/null || terraform workspace new ${{ matrix.student_id }}

      - name: Restore state
        run: |
          cd modules/${{ github.event.inputs.module }}
          mkdir -p .terraform.tfstate.d/${{ matrix.student_id }}
          aws s3 cp s3://do-not-delete-awsgoat-state-files-${{ env.ACCOUNT_ID }}/terraform.tfstate.${{ matrix.student_id }} .terraform.tfstate.d/${{ matrix.student_id }}/terraform.tfstate 2>/dev/null || true
        continue-on-error: true

      - uses: actions/setup-python@v5
        with:
          python-version: 3
      - name: Install boto3
        run: pip install boto3

      - name: Terraform Plan
        run: |
          cd modules/${{ github.event.inputs.module }}
          terraform workspace select ${{ matrix.student_id }} 2>/dev/null || terraform workspace new ${{ matrix.student_id }}
          terraform plan -input=false -var="student_id=${{ matrix.student_id }}" -var="region=${{ env.AWS_REGION }}"
        continue-on-error: false

      - name: Terraform Apply
        run: |
          cd modules/${{ github.event.inputs.module }}
          terraform workspace select ${{ matrix.student_id }} 2>/dev/null || terraform workspace new ${{ matrix.student_id }}
          terraform apply -auto-approve -input=false -var="student_id=${{ matrix.student_id }}" -var="region=${{ env.AWS_REGION }}"
        continue-on-error: false

      - name: Copy state to S3
        if: always()
        run: |
          BUCKET="do-not-delete-awsgoat-state-files-${{ env.ACCOUNT_ID }}"
          aws s3 mb "s3://${BUCKET}" 2>/dev/null || true
          cd modules/${{ github.event.inputs.module }}
          STATE_FILE=".terraform.tfstate.d/${{ matrix.student_id }}/terraform.tfstate"
          if [ -f "$STATE_FILE" ]; then
            aws s3 cp "$STATE_FILE" "s3://${BUCKET}/terraform.tfstate.${{ matrix.student_id }}"
          else
            echo "State file not found; skipping upload."
          fi

      - name: Outputs
        run: |
          cd modules/${{ github.event.inputs.module }}
          terraform output
