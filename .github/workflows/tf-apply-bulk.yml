name: 'Terraform Apply (Bulk)'

on:
  workflow_dispatch:
    inputs:
      number_of_instances:
        description: "Number of lab instances to launch (e.g. 5 for student-01 through student-05)"
        required: true
        type: number
      module:
        type: choice
        description: "Module to deploy for each instance"
        options:
          - module-1
          - module-2
        required: true
      region:
        description: "AWS region. Leave empty for eu-west-3 (Paris)."
        required: false
        type: string

permissions: write-all

jobs:
  generate-ids:
    name: 'Generate student IDs'
    runs-on: ubuntu-latest
    outputs:
      student_ids: ${{ steps.ids.outputs.student_ids }}
    steps:
      - name: Build student IDs array
        id: ids
        run: |
          n="${{ github.event.inputs.number_of_instances }}"
          [ -z "$n" ] || [ "$n" -lt 1 ] && n=1
          [ "$n" -gt 50 ] && n=50
          arr="["
          for i in $(seq 1 "$n"); do
            [ $i -gt 1 ] && arr+=","
            arr+="\"$(printf '%02d' $i)\""
          done
          arr+="]"
          echo "student_ids=$arr" >> $GITHUB_OUTPUT
          echo "Generated: $arr"

  bootstrap:
    name: 'Ensure state bucket exists'
    needs: generate-ids
    runs-on: ubuntu-latest
    environment: production
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: "eu-west-3"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.10.5
      - name: Set Account ID and Region
        run: |
          echo "ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_ENV
          echo "AWS_REGION=${{ github.event.inputs.region || env.AWS_REGION || 'eu-west-3' }}" >> $GITHUB_ENV
          aws configure set region ${{ env.AWS_REGION }}
      - name: Create state bucket if missing
        run: |
          BUCKET="do-not-delete-awsgoat-state-files-${{ env.ACCOUNT_ID }}"
          if aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
            echo "State bucket already exists: $BUCKET"
          else
            cd backend-bootstrap
            terraform init -input=false
            terraform apply -auto-approve -input=false -var="region=${{ env.AWS_REGION }}"
            echo "State bucket created: $BUCKET"
          fi

  terraform:
    name: 'Apply (${{ matrix.student_id }})'
    needs: [generate-ids, bootstrap]
    runs-on: ubuntu-latest
    environment: production
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        student_id: ${{ fromJson(needs.generate-ids.outputs.student_ids) }}
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: "eu-west-3"

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.10.5

      - name: Set Account ID and Region
        id: account
        run: |
          echo "ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_ENV
          echo "AWS_REGION=${{ github.event.inputs.region || env.AWS_REGION || 'eu-west-3' }}" >> $GITHUB_ENV
          aws configure set region ${{ env.AWS_REGION }}

      - name: Ensure state bucket exists
        run: |
          BUCKET="do-not-delete-awsgoat-state-files-${{ env.ACCOUNT_ID }}"
          if ! aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
            cd backend-bootstrap
            terraform init -input=false
            terraform apply -auto-approve -input=false -var="region=${{ env.AWS_REGION }}"
          fi

      - name: Terraform Init (S3 backend)
        run: |
          cd modules/${{ github.event.inputs.module }}
          terraform init -reconfigure -input=false \
            -backend-config="bucket=do-not-delete-awsgoat-state-files-${{ env.ACCOUNT_ID }}" \
            -backend-config="key=terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="workspace_key_prefix=${{ github.event.inputs.module }}"

      - name: Terraform Workspace
        run: |
          cd modules/${{ github.event.inputs.module }}
          terraform workspace select ${{ matrix.student_id }} 2>/dev/null || terraform workspace new ${{ matrix.student_id }}

      - name: Import existing resources (once, before plan)
        run: |
          chmod +x scripts/import-existing-resources.sh
          ACCOUNT_ID=${{ env.ACCOUNT_ID }} AWS_REGION=${{ env.AWS_REGION }} ./scripts/import-existing-resources.sh ${{ github.event.inputs.module }} ${{ matrix.student_id }}
        continue-on-error: true

      - uses: actions/setup-python@v5
        with:
          python-version: 3
      - name: Install boto3
        run: pip install boto3

      - name: Terraform Plan
        run: |
          cd modules/${{ github.event.inputs.module }}
          terraform workspace select ${{ matrix.student_id }} 2>/dev/null || terraform workspace new ${{ matrix.student_id }}
          terraform plan -input=false -var="student_id=${{ matrix.student_id }}" -var="region=${{ env.AWS_REGION }}"
        continue-on-error: false

      - name: Terraform Apply
        run: |
          cd modules/${{ github.event.inputs.module }}
          terraform workspace select ${{ matrix.student_id }} 2>/dev/null || terraform workspace new ${{ matrix.student_id }}
          terraform apply -auto-approve -input=false -var="student_id=${{ matrix.student_id }}" -var="region=${{ env.AWS_REGION }}"
        continue-on-error: false

      - name: Outputs
        if: success()
        run: |
          cd modules/${{ github.event.inputs.module }}
          terraform workspace select ${{ matrix.student_id }} 2>/dev/null || true
          terraform output
