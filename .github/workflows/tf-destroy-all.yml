name: 'Terraform Destroy All'

on:
  workflow_dispatch:
    inputs:
      region:
        description: "AWS region (must match the one used for deploy). Leave empty to use AWS_REGION env or eu-west-3 (Paris)."
        required: false
        type: string

permissions: write-all

jobs:
  destroy-all:
    name: 'Destroy All Deployments'
    runs-on: ubuntu-latest
    environment: production
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: "eu-west-3"

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.10.5

      - name: Set Account ID and Region
        id: account
        run: |
          echo "ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_ENV
          REGION="${{ github.event.inputs.region || env.AWS_REGION || 'eu-west-3' }}"
          echo "AWS_REGION=$REGION" >> $GITHUB_ENV
          aws configure set region "$REGION"

      - name: List workspaces (S3 backend keys)
        id: list-workspaces
        run: |
          BUCKET="do-not-delete-awsgoat-state-files-${{ env.ACCOUNT_ID }}-${{ env.AWS_REGION }}"
          aws s3 ls "s3://${BUCKET}/" --recursive --output text 2>/dev/null | awk '{print $4}' | while read -r key; do
            if [[ "$key" == *"/env:/"*"/terraform.tfstate" ]]; then
              mod="${key%%/env:*}"
              rest="${key#*env:/}"
              ws="${rest%%/terraform.tfstate*}"
              echo "$mod $ws"
            fi
          done > workspace_list.txt || true
          echo "Workspaces (module student_id):"
          cat workspace_list.txt 2>/dev/null || echo "(none)"

      - name: Destroy all (module-1 and module-2, each workspace)
        run: |
          BUCKET="do-not-delete-awsgoat-state-files-${{ env.ACCOUNT_ID }}-${{ env.AWS_REGION }}"
          ROOT="$GITHUB_WORKSPACE"

          if [ ! -s "$ROOT/workspace_list.txt" ]; then
            echo "No workspace state found in S3; nothing to destroy."
          else
            while IFS= read -r line; do
              [ -z "$line" ] && continue
              MODULE="${line%% *}"
              STUDENT_ID="${line#* }"
              echo "--- Destroying $MODULE student_id=$STUDENT_ID ---"
              cd "$ROOT/modules/$MODULE"
              terraform init -reconfigure -input=false \
                -backend-config="bucket=${BUCKET}" \
                -backend-config="key=terraform.tfstate" \
                -backend-config="region=${{ env.AWS_REGION }}" \
                -backend-config="workspace_key_prefix=${MODULE}"
              terraform workspace select "$STUDENT_ID" 2>/dev/null || true
              terraform destroy -auto-approve -input=false -var="student_id=${STUDENT_ID}" -var="region=${{ env.AWS_REGION }}" || true
            done < "$ROOT/workspace_list.txt"
          fi
          echo "=== Destroy all completed ==="

      - name: Delete state bucket (bootstrap S3)
        run: |
          BUCKET="do-not-delete-awsgoat-state-files-${{ env.ACCOUNT_ID }}-${{ env.AWS_REGION }}"
          if ! aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
            echo "State bucket $BUCKET does not exist; skipping."
            exit 0
          fi
          echo "Emptying versioned state bucket: $BUCKET"
          while true; do
            out=$(aws s3api list-object-versions --bucket "$BUCKET" --output json 2>/dev/null) || break
            echo "$out" | jq -c '.Versions[]? | {Key, VersionId}' 2>/dev/null | while read -r obj; do
              [ -z "$obj" ] && continue
              aws s3api delete-object --bucket "$BUCKET" --key "$(echo "$obj" | jq -r .Key)" --version-id "$(echo "$obj" | jq -r .VersionId)" 2>/dev/null || true
            done
            echo "$out" | jq -c '.DeleteMarkers[]? | {Key, VersionId}' 2>/dev/null | while read -r obj; do
              [ -z "$obj" ] && continue
              aws s3api delete-object --bucket "$BUCKET" --key "$(echo "$obj" | jq -r .Key)" --version-id "$(echo "$obj" | jq -r .VersionId)" 2>/dev/null || true
            done
            has_more=$(echo "$out" | jq -r '.Versions | length + (.DeleteMarkers | length)')
            [ "${has_more:-0}" -eq 0 ] && break
          done
          echo "Deleting bucket: $BUCKET"
          aws s3 rb "s3://${BUCKET}" --force 2>/dev/null || aws s3api delete-bucket --bucket "$BUCKET"
          echo "State bucket deleted."

      - name: Delete all resources tagged Project=AWSGoat
        run: |
          chmod +x scripts/delete-resources-by-tag-awsgoat.sh
          ./scripts/delete-resources-by-tag-awsgoat.sh
        continue-on-error: true

